name: (Code) Snyk Code Summary with PR Comment

on:
  pull_request:

env:
  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

jobs:
  snyk-code-summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: npm install

      - name: Install Snyk CLI
        uses: snyk/actions/setup@master

      - name: Run Snyk Code test
        run: snyk code test --json > snyk-code-results.json || true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Generate PR comment summary (Code)
        run: |
          node <<'EOF'
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('snyk-code-results.json', 'utf8'));

          const results = data.runs?.[0]?.results || [];
          const rules = (data.runs?.[0]?.tool?.driver?.rules || []).reduce((acc, rule) => {
            acc[rule.id] = rule;
            return acc;
          }, {});

          const repoUrl = process.env.GITHUB_SERVER_URL + '/' + process.env.GITHUB_REPOSITORY;
          const commit = process.env.GITHUB_SHA;

          const severityIcons = { high: '🟠', medium: '🟡', low: '🟢' };
          const severityRank = { high: 3, medium: 2, low: 1 };

          const annotatedResults = results.map(r => {
            const rule = rules[r.ruleId] || {};
            const severity = rule?.properties?.securitySeverityLevel || 'low';
            return { ...r, severity };
          });

          const filtered = annotatedResults.filter(r => ['high', 'medium'].includes(r.severity));

          const output = [];
          output.push('<!-- SNYK_CODE_SUMMARY -->');
          output.push('## 🛡️ Snyk Code Issues Summary\n');

          if (filtered.length === 0) {
            output.push('_No high or medium severity issues found._\n');
          } else {
            output.push('| Severity | File | Line | Message | Rule ID |');
            output.push('|----------|------|------|---------|---------|');

            for (const issue of filtered.sort((a, b) => severityRank[b.severity] - severityRank[a.severity])) {
              const icon = severityIcons[issue.severity] || '';
              const loc = issue.locations?.[0]?.physicalLocation || {};
              const file = loc.artifactLocation?.uri || 'unknown';
              const line = loc.region?.startLine || 'N/A';
              const message = issue.message?.text?.replace(/\|/g, '\\|') || 'N/A';
              const ruleId = issue.ruleId || 'N/A';
              const fileLink = `${repoUrl}/blob/${commit}/${file}#L${line}`;

              output.push(`| ${icon} ${issue.severity.toUpperCase()} | [${file}](${fileLink}) | ${line} | ${message} | ${ruleId} |`);
            }
          }

          output.push('\n---\n');
          output.push('ℹ️ Showing only **high** and **medium** severity issues as reported by `snyk code test`.\n');
          fs.writeFileSync('pr-comment-code.md', output.join('\n'));
          EOF

      - name: Add summary to PR Checks tab
        run: cat pr-comment-code.md >> $GITHUB_STEP_SUMMARY

      - name: Edit or create Snyk Code PR comment
        if: github.event_name == 'pull_request'
        run: |
          COMMENT_ID=$(gh pr view "$PR_URL" --json comments -q '.comments[] | select(.body | contains("<!-- SNYK_CODE_SUMMARY -->")) | .id')
          if [ -n "$COMMENT_ID" ]; then
            gh pr comment "$PR_URL" --edit-last --body-file pr-comment-code.md
          else
            gh pr comment "$PR_URL" --body-file pr-comment-code.md
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
